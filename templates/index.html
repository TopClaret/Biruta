<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reiniciar Servi√ßo de Impress√£o</title>
    <style nonce="{{ csp_nonce }}">
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 800px; /* Aumentado para acomodar o novo layout */
            margin: 20px;
        }

        .connection-config {
            background-color: #f0f2f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .connection-config h2 {
            grid-column: 1 / -1; /* Ocupa todas as colunas */
            text-align: left;
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .input-group label {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .connection-config input[type="text"],
        .connection-config input[type="password"],
        .connection-config input[type="number"] {
            width: calc(100% - 20px);
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .connection-config button {
            grid-column: span 1; /* Pode ajustar conforme necess√°rio */
            padding: 10px 15px;
            font-size: 0.9em;
            margin-top: 10px; /* Para alinhar com os inputs */
        }

        .tabs-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f8f9fa;
            padding: 10px;
        }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 10px;
        }

        .tab-button {
            background-color: #e9ecef;
            color: #495057;
            padding: 10px 15px;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-right: 2px;
        }

        .tab-button:hover {
            background-color: #dee2e6;
        }

        .tab-button.active {
            background-color: #fff;
            color: #3498db;
            border-bottom: 1px solid #fff;
            font-weight: bold;
        }

        .tab-pane {
            display: none;
            padding: 15px 0;
        }

        .tab-pane.active {
            display: block;
        }

        .filter-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-group label {
            margin-right: 10px;
            font-weight: bold;
            color: #555;
        }

        .filter-group input[type="text"] {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9em;
        }

        /* Estilos existentes para bot√µes, mensagens, printer-grid e service-grid */
        button {
            background-color: #3498db; /* Azul mais vibrante */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        #message {
            margin-top: 20px;
            font-weight: bold;
            color: #333;
            text-align: left;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .printer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .printer-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: left;
            transition: transform 0.2s ease-in-out;
        }
        .printer-card:hover {
            transform: translateY(-5px);
        }
        .printer-card h4 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .printer-card p {
            margin: 5px 0;
            color: #555;
            font-size: 0.9em;
        }
        .printer-card p strong {
            color: #333;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .service-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: left;
            transition: transform 0.2s ease-in-out;
        }

        .service-card:hover {
            transform: translateY(-3px);
        }

        .service-card h4 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .service-card p {
            margin: 4px 0;
            color: #555;
            font-size: 0.85em;
        }

        .service-card p strong {
            color: #333;
        }

        .status-running {
            color: #28a745; /* Verde */
            font-weight: bold;
        }

        .status-stopped {
            color: #dc3545; /* Vermelho */
            font-weight: bold;
        }

        .status-paused {
            color: #ffc107; /* Amarelo/Laranja */
            font-weight: bold;
        }

        .status-pending, .status-start_pending, .status-stop_pending {
            color: #007bff; /* Azul */
            font-weight: bold;
        }

        .status-not_found, .status-error {
            color: #6c757d; /* Cinza */
            font-weight: bold;
        }

        #toastOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        #toast {
            background: #ffffff;
            border-radius: 10px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            max-width: 460px;
            width: calc(100% - 40px);
            text-align: center;
            position: relative;
        }
        .toast-success {
            border-left: 6px solid #28a745;
        }
        .toast-error {
            border-left: 6px solid #dc3545;
        }
        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .toast-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #28a745;
            color: #fff;
            font-weight: bold;
            font-size: 18px;
        }
        .toast-title {
            font-weight: 700;
            color: #2f3941;
            margin: 10px 0 6px 0;
            font-size: 1.05em;
        }
        .toast-info {
            color: #6c757d;
            font-size: 0.95em;
        }
        #toastClose {
            background: transparent;
            border: none;
            font-size: 20px;
            line-height: 20px;
            color: #6c757d;
            cursor: pointer;
        }

        /* Redesign moderno */
        html, body { height: 100%; }
        body {
            margin: 0;
            background: radial-gradient(1200px 600px at 20% -20%, #1d4ed8 0%, transparent 60%), radial-gradient(1000px 500px at 120% 20%, #7c3aed 0%, transparent 55%), #0f172a;
            color: #e5e7eb;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.45;
        }
        .container {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 28px;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            width: 100%;
            max-width: 980px;
            margin: 40px auto;
        }
        .connection-config {
            background: #111827;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px 16px;
            margin-bottom: 22px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            column-gap: 12px;
            row-gap: 12px;
            align-items: center;
            justify-items: stretch;
        }
        .connection-config h2 {
            color: #e5e7eb;
            margin: 0 0 12px 0;
            font-size: 1.25em;
            letter-spacing: 0.3px;
        }
        .input-group { display:flex; flex-direction:column; align-items:flex-start; gap: 8px; }
        .input-group label { color: #9ca3af; font-weight: 600; }
        .connection-config input[type="text"],
        .connection-config input[type="password"],
        .connection-config input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.12);
            background: #1f2937;
            color: #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
            outline: none;
            box-sizing: border-box;
        }
        .tabs-container { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; background: #111827; padding: 14px; }
        .tabs-header { display:flex; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom:12px; }
        .tab-button { background: transparent; color: #9ca3af; padding: 10px 16px; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 1em; transition: all 0.2s ease; margin-right: 8px; }
        .tab-button:hover { color: #e5e7eb; }
        .tab-button.active { color: #e5e7eb; border-bottom-color: #3b82f6; font-weight: 700; }
        button { display:inline-flex; align-items:center; gap:8px; background: #3b82f6; color:#fff; padding: 12px 18px; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 6px 16px rgba(59,130,246,0.35); }
        button:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 10px 20px rgba(37,99,235,0.35); }
        button:disabled { background: #6b7280; cursor:not-allowed; box-shadow:none; transform:none; }
        .button-indent { margin-left: 0; }
        .btn-row { display:flex; align-items:center; gap:10px; margin-left: 0; }
        
        #message { margin-top: 18px; font-weight: 600; color: #e5e7eb; text-align: left; }
        .printer-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:18px; margin-top:16px; padding: 8px; background: #ffffff; border-radius: 12px; border:1px solid #e5e7eb; }
        .printer-card { background: #ffffff; border:1px solid #e0e0e0; border-radius: 12px; padding: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.08); text-align:left; transition: transform .2s ease, box-shadow .2s ease; }
        .printer-card:hover { transform: translateY(-3px); }
        .printer-card h4 { color: #34495e; margin:0 0 10px 0; font-size:0.95em; border-bottom: 1px dashed rgba(0,0,0,0.08); padding-bottom:6px; }
        .printer-card p { margin: 6px 0; color: #555; font-size: 0.9em; }
        .service-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; margin-top:14px; padding: 8px; background: #111827; border-radius: 12px; border:1px solid rgba(255,255,255,0.06); }
        .service-card { background: #1f2937; border:1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); text-align:left; transition: transform .2s ease, box-shadow .2s ease; }
        .service-card:hover { transform: translateY(-2px); }
        .service-card h4 { color: #e5e7eb; margin:0 0 8px 0; font-size:1em; border-bottom: 1px dashed rgba(255,255,255,0.08); padding-bottom:4px; }
        .service-card p { margin: 4px 0; color: #9ca3af; font-size: 0.85em; }
        .status-running { color: #22c55e; font-weight: 700; }
        .status-stopped { color: #ef4444; font-weight: 700; }
        .status-paused { color: #f59e0b; font-weight: 700; }
        .status-pending, .status-start_pending, .status-stop_pending { color: #3b82f6; font-weight: 700; }
        .status-not_found, .status-error { color: #9ca3af; font-weight: 700; }
        #toastOverlay { background: rgba(0, 0, 0, 0.45); }
        #toast { background: #1f2937; border:1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 18px 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); max-width: 520px; }
        .toast-success { border-left: 6px solid #22c55e; }
        .toast-error { border-left: 6px solid #ef4444; }
        .toast-icon { background: #22c55e; }
        #toastClose { color: #9ca3af; }
        @media (max-width: 640px) {
            .container { margin: 20px auto; padding: 20px; }
            .connection-config { grid-template-columns: 1fr; gap: 12px; padding: 16px; }
            .tab-button { padding: 8px 10px; }
            .tabs-header { flex-wrap: wrap; }
            button { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="toastOverlay">
            <div id="toast" class="toast-success">
                <div class="toast-header">
                    <span id="toastIcon" class="toast-icon">‚úì</span>
                    <button id="toastClose">√ó</button>
                </div>
                <div class="toast-title" id="toastTitle"></div>
                <div class="toast-info" id="toastInfo"></div>
            </div>
        </div>
        <div class="connection-config">
            <h2>Configura√ß√µes de Conex√£o</h2>
            <div class="input-group">
                <label for="remoteHost">IP/M√°quina:</label>
                <input type="text" id="remoteHost" placeholder="Nome do Host ou IP Remoto">
            </div>
            <div class="input-group">
                <label for="username">Usu√°rio:</label>
                <input type="text" id="username" placeholder="Usu√°rio (para acesso remoto)">
            </div>
            <div class="input-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" placeholder="Senha (para acesso remoto)" autocomplete="current-password" autocapitalize="off" spellcheck="false">
            </div>
            <div class="input-group">
                <label for="domain">Dom√≠nio:</label>
                <input type="text" id="domain" placeholder="Dom√≠nio (opcional)">
            </div>
            
            <button id="connectButton" class="button-indent">Conectar</button>
        </div>

        <p id="message"></p>

        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="services">Servi√ßos</button>
                <button class="tab-button" data-tab="printers">Impressoras</button>
            </div>
            <div class="tabs-content">
                <div id="services" class="tab-pane active">
                    <div class="filter-group">
                        <label for="serviceFilter">Filtro de Servi√ßos:</label>
                        <input type="text" id="serviceFilter" placeholder="Filtrar servi√ßos...">
                    </div>
                    <button id="restartButton" class="button-indent">Reiniciar Servi√ßos</button>
                    <div id="servicesOutput" class="service-grid"></div>
                </div>
                <div id="printers" class="tab-pane">
                    <div class="btn-row">
                        <button id="listPrintersButton">Listar Impressoras</button>
                        <button id="robustClearButton" style="background:#e74c3c;">üßπ Limpar Fila (Robusto)</button>
                    </div>
                    <div id="printersOutput" class="printer-grid"></div>
                </div>
                
            </div>
        </div>


    </div>

    <script nonce="{{ csp_nonce }}">
        let printerUpdateInterval = null;
        let serviceStatusInterval = null;
        let statusEventSource = null;
        let sseReconnectTimer = null;
        let serviceMonitorToken = null;
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }
        function csrfHeaders() {
            const token = getCookie('XSRF-TOKEN');
            return token ? { 'X-CSRF-Token': token } : {};
        }
        document.getElementById('restartButton').addEventListener('click', async () => {
            const button = document.getElementById('restartButton');
            const message = document.getElementById('message');

            const servicesOutput = document.getElementById('servicesOutput');
            const remoteHost = document.getElementById('remoteHost').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!remoteHost) {
                servicesOutput.innerHTML = '<p>Por favor, insira o IP/M√°quina para listar os servi√ßos.</p>';
                return;
            }

            button.disabled = true;
            message.textContent = 'Reiniciando servi√ßos sequencialmente...';
            message.className = '';

            try {
                const restartServicesResponse = await fetch('/restart_multiple_services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...csrfHeaders()
                    },
                    body: JSON.stringify({ remote_host: remoteHost, username: username, password: password })
                });

                const restartServicesData = await restartServicesResponse.json();

                if (restartServicesResponse.ok) {
                    message.textContent = restartServicesData.message;
                    message.className = 'success';
                    fetchAndRenderServiceStatus();
                } else {
                    message.textContent = restartServicesData.message || 'Erro desconhecido ao iniciar o rein√≠cio sequencial.';
                    message.className = 'error';
                    if (restartServicesData.results) {
                        const errorDetails = restartServicesData.results.filter(res => res.status === 'error').map(res => `${res.service}: ${res.message}`).join('\n');
                        if (errorDetails) {
                            message.textContent += `\nDetalhes dos erros:\n${errorDetails}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                message.textContent = 'N√£o foi poss√≠vel conectar ao servidor. Certifique-se de que o aplicativo est√° rodando.';
                message.className = 'error';
            } finally {
                button.disabled = false;
            }
        });



        async function fetchAndRenderPrinters() {
            const button = document.getElementById('listPrintersButton');
            const message = document.getElementById('message');
            const printersOutput = document.getElementById('printersOutput');

            const remoteHost = document.getElementById('remoteHost').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            button.disabled = true;
            
            message.textContent = 'Listando impressoras...';
            message.className = '';
            // N√£o limpa o output para permitir atualiza√ß√£o in-place

            try {
                const response = await fetch('/list_printers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...csrfHeaders()
                    },
                    body: JSON.stringify({ remote_host: remoteHost, username: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    message.textContent = data.message;
                    message.className = 'success';
                    printersOutput.innerHTML = ''; // Limpa antes de renderizar para atualiza√ß√£o
                    if (data.printers && data.printers.length > 0) {
                        const escapeHtml = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
                        data.printers.forEach(printer => {
                            const printerCard = document.createElement('div');
                            printerCard.className = 'printer-card';
                            const nameEl = document.createElement('h4');
                            nameEl.textContent = printer.Name;
                            printerCard.appendChild(nameEl);
                            const makeP = (label, val) => {
                                const p = document.createElement('p');
                                const strong = document.createElement('strong');
                                strong.textContent = label;
                                p.appendChild(strong);
                                p.appendChild(document.createTextNode(' ' + (val == null ? 'N/A' : String(val))));
                                return p;
                            };
                            printerCard.appendChild(makeP('Localiza√ß√£o:', printer.Location));
                            printerCard.appendChild(makeP('Driver:', printer.DriverName));
                            printerCard.appendChild(makeP('Porta:', printer.PortName));
                            printerCard.appendChild(makeP('Compartilhada:', printer.ShareName || 'N√£o'));
                            printerCard.appendChild(makeP('Status:', printer.Status || 'Desconhecido'));
                            printerCard.appendChild(makeP('Padr√£o:', printer.Default ? 'Sim' : 'N√£o'));
                            printerCard.appendChild(makeP('Local:', printer.Local ? 'Sim' : 'N√£o'));
                            printerCard.appendChild(makeP('Rede:', printer.Network ? 'Sim' : 'N√£o'));
                            printerCard.appendChild(makeP('Trabalhos Pendentes:', printer.JobCount));
                            printersOutput.appendChild(printerCard);
                        });
                    } else {
                        printersOutput.innerHTML = '<p>Nenhuma impressora encontrada.</p>';
                    }
                } else {
                    message.textContent = data.message || 'Erro desconhecido ao listar impressoras.';
                    message.className = 'error';

                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                message.textContent = 'N√£o foi poss√≠vel conectar ao servidor para listar impressoras. Certifique-se de que o aplicativo est√° rodando.';
                message.className = 'error';

            } finally {
                button.disabled = false;
            }
        }

        document.getElementById('robustClearButton').addEventListener('click', async () => {
            const message = document.getElementById('message');
            const remoteHost = document.getElementById('remoteHost').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const domain = document.getElementById('domain').value.trim();
            if (!remoteHost || !username || !password) {
                showToast('error', 'Dados incompletos', 'Informe IP, usu√°rio e senha.');
                return;
            }
            try {
                message.textContent = 'Executando limpeza robusta da fila...';
                message.className = '';
                const resp = await fetch('/clear_print_jobs_robust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username, password, domain })
                });
                const data = await resp.json();
                if (resp.ok) {
                    const before = data.before_count ?? 0;
                    const after = data.after_count ?? 0;
                    showToast('success', 'Fila limpa (robusto)', `Antes: ${before} | Depois: ${after}`);
                    await new Promise(r => setTimeout(r, 1500));
                    await fetchAndRenderPrinters();
                } else {
                    showToast('error', 'Erro ao limpar fila', data.message || 'Erro desconhecido');
                }
            } catch (e) {
                showToast('error', 'Falha de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
            }
        });

        document.getElementById('listPrintersButton').addEventListener('click', () => {
            // Limpa qualquer intervalo existente antes de iniciar um novo
            if (printerUpdateInterval) {
                clearInterval(printerUpdateInterval);
            }
            fetchAndRenderPrinters(); // Chama imediatamente
        });

        

        // Fun√ß√£o para buscar e renderizar o status dos servi√ßos
        async function fetchAndRenderServiceStatus() {
            const servicesOutput = document.getElementById('servicesOutput');
            const remoteHost = document.getElementById('remoteHost').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/get_services_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...csrfHeaders()
                    },
                    body: JSON.stringify({ remote_host: remoteHost, username: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    servicesOutput.innerHTML = ''; // Limpa antes de renderizar
                    if (data.services && data.services.length > 0) {
                        data.services.forEach(service => {
                            const serviceCard = document.createElement('div');
                            serviceCard.className = 'service-card';
                            const statusClass = `status-${service.status.toLowerCase().replace(/ /g, '_')}`;
                            serviceCard.innerHTML = `
                                <h4>${service.name}</h4>
                                <p>Status: <span class="${statusClass}">${service.status}</span></p>
                            `;
                            servicesOutput.appendChild(serviceCard);
                        });
                    } else {
                        servicesOutput.innerHTML = '<p>Nenhum servi√ßo encontrado ou monitorado.</p>';
                    }
                } else {
                    console.error('Erro ao buscar status dos servi√ßos:', data.message);
                    servicesOutput.innerHTML = `<p class="error">Erro ao carregar status dos servi√ßos: ${data.message || 'Erro desconhecido'}</p>`;
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o de status dos servi√ßos:', error);
                servicesOutput.innerHTML = '<p class="error">N√£o foi poss√≠vel conectar ao servidor para obter o status dos servi√ßos.</p>';
            }
        }

        function renderServiceList(services) {
            const servicesOutput = document.getElementById('servicesOutput');
            servicesOutput.innerHTML = '';
            if (services && services.length > 0) {
                services.forEach(service => {
                    const serviceCard = document.createElement('div');
                    serviceCard.className = 'service-card';
                    const statusClass = `status-${service.status.toLowerCase().replace(/ /g, '_')}`;
                    const progress = statusToProgress(service.status);
                    const color = statusToColor(service.status);
                    serviceCard.innerHTML = `
                                <h4>${service.name}</h4>
                                <p>Status: <span class="${statusClass}">${service.status}</span></p>
                                <div class="service-progress" style="background:#eee;height:6px;border-radius:3px;">
                                    <div class="service-progress-bar" style="width:${progress}%;height:6px;background:${color};border-radius:3px;"></div>
                                </div>
                            `;
                    servicesOutput.appendChild(serviceCard);
                });
            } else {
                servicesOutput.innerHTML = '<p>Nenhum servi√ßo encontrado ou monitorado.</p>';
            }
        }

        function statusToProgress(status) {
            const s = String(status).toLowerCase();
            if (s.includes('running')) return 100;
            if (s.includes('start') && s.includes('pending')) return 75;
            if (s.includes('stopped')) return 50;
            if (s.includes('stop') && s.includes('pending')) return 25;
            if (s.includes('error')) return 0;
            return 0;
        }

        function statusToColor(status) {
            const s = String(status).toLowerCase();
            if (s.includes('running')) return '#28a745';
            if (s.includes('start') && s.includes('pending')) return '#ffc107';
            if (s.includes('stopped')) return '#6c757d';
            if (s.includes('stop') && s.includes('pending')) return '#ffc107';
            if (s.includes('error')) return '#dc3545';
            return '#6c757d';
        }

        async function startServiceMonitorIfNeeded() {
            const remoteHost = document.getElementById('remoteHost').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!remoteHost) {
                return null;
            }
            try {
                const resp = await fetch('/start_service_monitor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username, password })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    serviceMonitorToken = data.token;
                    return serviceMonitorToken;
                }
            } catch (e) {}
            return null;
        }

        async function connectServiceStatusEvents() {
            if (statusEventSource) return;
            let url = '/events/services_status';
            if (!serviceMonitorToken) {
                await startServiceMonitorIfNeeded();
            }
            if (serviceMonitorToken) {
                url = `/events/services_status_by_token?token=${serviceMonitorToken}`;
            }
            statusEventSource = new EventSource(url);
            statusEventSource.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    if (data && data.all && data.all.length) {
                        renderServiceList(data.all);
                    }
                    if (data && data.changed && data.changed.length > 0) {
                        const now = new Date();
                        const info = data.changed.map(c => `${c.service}: ${c.status} (${now.toLocaleString()})`).join('<br>');
                        data.changed.forEach(c => {
                            const cards = document.querySelectorAll('#servicesOutput .service-card');
                            cards.forEach(card => {
                                const name = card.querySelector('h4').textContent;
                                if (name === c.service) {
                                    const span = card.querySelector('span');
                                    const cls = `status-${String(c.status).toLowerCase().replace(/ /g, '_')}`;
                                    span.textContent = c.status;
                                    span.className = cls;
                                    const bar = card.querySelector('.service-progress-bar');
                                    if (bar) {
                                        bar.style.width = statusToProgress(c.status) + '%';
                                        bar.style.background = statusToColor(c.status);
                                    }
                                }
                            });
                        });
                    }
                } catch (_) {}
            };
            statusEventSource.onerror = () => {
                if (statusEventSource) {
                    statusEventSource.close();
                    statusEventSource = null;
                }
                if (!sseReconnectTimer) {
                    sseReconnectTimer = setTimeout(() => {
                        sseReconnectTimer = null;
                        connectServiceStatusEvents();
                    }, 2000);
                }
            };
        }

        function disconnectServiceStatusEvents() {
            if (statusEventSource) {
                statusEventSource.close();
                statusEventSource = null;
            }
            if (sseReconnectTimer) {
                clearTimeout(sseReconnectTimer);
                sseReconnectTimer = null;
            }
        }

        // Chama a fun√ß√£o de status dos servi√ßos ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            connectServiceStatusEvents();
        });

        // Adiciona event listeners para os bot√µes das abas
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                showTab(tabId);
            });
        });

        function showTab(tabId) {
            // Remove a classe 'active' de todos os bot√µes e pain√©is
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            // Adiciona a classe 'active' ao bot√£o e painel da aba selecionada
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // L√≥gica espec√≠fica para cada aba ao ser ativada
            if (tabId === 'services') {
                connectServiceStatusEvents();
                if (serviceStatusInterval) {
                    clearInterval(serviceStatusInterval);
                    serviceStatusInterval = null;
                }
            } else {
                disconnectServiceStatusEvents();
            }

            if (tabId === 'printers') {
                // N√£o inicia o intervalo automaticamente, apenas quando o bot√£o √© clicado
                // fetchAndRenderPrinters(); 
            } else {
                clearInterval(printerUpdateInterval);
                printerUpdateInterval = null;
            }
        }

        const toastOverlay = document.getElementById('toastOverlay');
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastInfo = document.getElementById('toastInfo');
        const toastIcon = document.getElementById('toastIcon');
        const toastClose = document.getElementById('toastClose');
        let toastTimer = null;

        function showToast(type, title, info, autoHideMs = 5000) {
            toast.className = type === 'success' ? 'toast-success' : 'toast-error';
            toastIcon.textContent = type === 'success' ? '‚úì' : '!';
            toastIcon.style.background = type === 'success' ? '#28a745' : '#dc3545';
            toastTitle.textContent = title;
            toastInfo.innerHTML = info;
            toastOverlay.style.display = 'flex';
            if (toastTimer) {
                clearTimeout(toastTimer);
            }
            if (autoHideMs && autoHideMs > 0) {
                toastTimer = setTimeout(() => hideToast(), autoHideMs);
            }
        }

        function hideToast() {
            toastOverlay.style.display = 'none';
            if (toastTimer) {
                clearTimeout(toastTimer);
                toastTimer = null;
            }
        }

        toastClose.addEventListener('click', hideToast);

        document.getElementById('connectButton').addEventListener('click', async () => {
            const remoteHost = document.getElementById('remoteHost').value.trim();
            const usernameInput = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const domain = document.getElementById('domain').value.trim();
            const connectBtn = document.getElementById('connectButton');
            const messageElement = document.getElementById('message');

            const composedUser = domain ? `${domain}\\${usernameInput}` : usernameInput;

            if (!remoteHost || !usernameInput || !password) {
                messageElement.textContent = 'Informe IP, usu√°rio e senha.';
                messageElement.className = 'error';
                return;
            }

            connectBtn.disabled = true;
            messageElement.textContent = 'Conectando...';
            messageElement.className = '';

            try {
                const response = await fetch('/test_wmi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username: composedUser, password })
                });
                const data = await response.json();
                const now = new Date();
                const infoHtml = `IP: ${remoteHost}<br>Data/Hora: ${now.toLocaleString()}<br>Status: ${response.ok ? 'Conectado' : 'Erro'}`;
                if (response.ok && data.status === 'success') {
                    messageElement.textContent = data.message;
                    messageElement.className = 'success';
                    fetchAndRenderServiceStatus();
                } else {
                    const errMsg = data && data.message ? data.message : 'Falha ao conectar.';
                    messageElement.textContent = errMsg;
                    messageElement.className = 'error';
                }
            } catch (e) {
                const now = new Date();
                const infoHtml = `IP: ${remoteHost}<br>Data/Hora: ${now.toLocaleString()}<br>Status: Erro`;
                messageElement.textContent = 'N√£o foi poss√≠vel conectar ao servidor. Certifique-se de que o aplicativo est√° rodando.';
                messageElement.className = 'error';
            } finally {
                connectBtn.disabled = false;
            }
        });

        // Event listener para o filtro de servi√ßos
        document.getElementById('serviceFilter').addEventListener('keyup', (event) => {
            const filterText = event.target.value.toLowerCase();
            const serviceCards = document.querySelectorAll('#servicesOutput .service-card');
            serviceCards.forEach(card => {
                const serviceName = card.querySelector('h4').textContent.toLowerCase();
                if (serviceName.includes(filterText)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

    </script>
</body>
</html>
