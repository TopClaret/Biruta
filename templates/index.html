<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reiniciar Servi√ßo de Impress√£o</title>
    <style nonce="{{ csp_nonce }}">
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 800px; /* Aumentado para acomodar o novo layout */
            margin: 20px;
        }

        .connection-config {
            background-color: #f0f2f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .connection-config h2 {
            grid-column: 1 / -1; /* Ocupa todas as colunas */
            text-align: left;
            color: #34495e;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .input-group label {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .connection-config input[type="text"],
        .connection-config input[type="password"],
        .connection-config input[type="number"] {
            width: calc(100% - 20px);
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .connection-config button {
            grid-column: span 1; /* Pode ajustar conforme necess√°rio */
            padding: 10px 15px;
            font-size: 0.9em;
            margin-top: 10px; /* Para alinhar com os inputs */
        }

        .tabs-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f8f9fa;
            padding: 10px;
        }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 10px;
        }

        .tab-button {
            background-color: #e9ecef;
            color: #495057;
            padding: 10px 15px;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-right: 2px;
        }

        .tab-button:hover {
            background-color: #dee2e6;
        }

        .tab-button.active {
            background-color: #fff;
            color: #3498db;
            border-bottom: 1px solid #fff;
            font-weight: bold;
        }

        .tab-pane {
            display: none;
            padding: 15px 0;
        }

        .tab-pane.active {
            display: block;
        }

        .filter-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-group label {
            margin-right: 10px;
            font-weight: bold;
            color: #555;
        }

        .filter-group input[type="text"] {
            flex-grow: 1;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9em;
        }

        /* Estilos existentes para bot√µes, mensagens, printer-grid e service-grid */
        button {
            background-color: #3498db; /* Azul mais vibrante */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #2980b9;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        #message {
            margin-top: 20px;
            font-weight: bold;
            color: #333;
            text-align: left;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .printer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .printer-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: left;
            transition: transform 0.2s ease-in-out;
        }
        .printer-card:hover {
            transform: translateY(-5px);
        }
        .printer-card h4 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .printer-card p {
            margin: 5px 0;
            color: #555;
            font-size: 0.9em;
        }
        .printer-card p strong {
            color: #333;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .service-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: left;
            transition: transform 0.2s ease-in-out;
        }

        .service-card:hover {
            transform: translateY(-3px);
        }

        .service-card h4 {
            color: #34495e;
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1em;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .service-card p {
            margin: 4px 0;
            color: #555;
            font-size: 0.85em;
        }

        .service-card p strong {
            color: #333;
        }

        .status-running { color: #00FF00; font-weight: 700; }
        .status-restarting, .status-pending, .status-start_pending, .status-stop_pending { color: #FFFF00; font-weight: 700; }
        .status-stopped { color: #FF0000; font-weight: 700; }
        .status-paused { color: #FFFF00; font-weight: 700; }
        .status-not_found, .status-error { color: #9ca3af; font-weight: 700; }
        .service-card span { transition: color .25s ease; }

        #toastOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        #toast {
            background: #ffffff;
            border-radius: 10px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            max-width: 460px;
            width: calc(100% - 40px);
            text-align: center;
            position: relative;
        }
        .toast-success {
            border-left: 6px solid #28a745;
        }
        .toast-error {
            border-left: 6px solid #dc3545;
        }
        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .toast-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #28a745;
            color: #fff;
            font-weight: bold;
            font-size: 18px;
        }
        .toast-title {
            font-weight: 700;
            color: #2f3941;
            margin: 10px 0 6px 0;
            font-size: 1.05em;
        }
        .toast-info {
            color: #6c757d;
            font-size: 0.95em;
        }
        #toastClose {
            background: transparent;
            border: none;
            font-size: 20px;
            line-height: 20px;
            color: #6c757d;
            cursor: pointer;
        }

        /* Redesign moderno */
        html, body { height: 100%; }
        body {
            margin: 0;
            background: radial-gradient(1200px 600px at 20% -20%, #1d4ed8 0%, transparent 60%), radial-gradient(1000px 500px at 120% 20%, #7c3aed 0%, transparent 55%), #0f172a;
            color: #e5e7eb;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.45;
        }
        .container {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 28px;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            width: 100%;
            max-width: 980px;
            margin: 40px auto;
        }
        .connection-config {
            background: #111827;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px 16px;
            margin-bottom: 22px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            column-gap: 12px;
            row-gap: 12px;
            align-items: center;
            justify-items: stretch;
        }
        .connection-config h2 {
            color: #e5e7eb;
            margin: 0 0 12px 0;
            font-size: 1.25em;
            letter-spacing: 0.3px;
        }
        .input-group { display:flex; flex-direction:column; align-items:flex-start; gap: 8px; }
        .input-group label { color: #9ca3af; font-weight: 600; }
        .connection-config input[type="text"],
        .connection-config input[type="password"],
        .connection-config input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.12);
            background: #1f2937;
            color: #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
            outline: none;
            box-sizing: border-box;
        }
        .tabs-container { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; background: #111827; padding: 14px; }
        .tabs-header { display:flex; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom:12px; }
        .tab-button { background: transparent; color: #9ca3af; padding: 10px 16px; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 1em; transition: all 0.2s ease; margin-right: 8px; }
        .tab-button:hover { color: #e5e7eb; }
        .tab-button.active { color: #e5e7eb; border-bottom-color: #3b82f6; font-weight: 700; }
        button { display:inline-flex; align-items:center; gap:8px; background: #3b82f6; color:#fff; padding: 12px 18px; border: none; border-radius: 10px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 6px 16px rgba(59,130,246,0.35); }
        button:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 10px 20px rgba(37,99,235,0.35); }
        button:disabled { background: #6b7280; cursor:not-allowed; box-shadow:none; transform:none; }
        .button-indent { margin-left: 0; }
        .btn-row { display:flex; align-items:center; gap:10px; margin-left: 0; flex-wrap: wrap; }
        .hint { color:#9ca3af; font-size: 0.8em; }
        .field-error { border-color:#ef4444 !important; background-color: #fef2f2; }
        .field-success { border-color:#10b981 !important; background-color: #f0fdf4; }
        .error-text { color:#ef4444; font-size:0.85em; }
        
        /* Sistema de Alertas Personalizados */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            border-left: 4px solid;
            background: #1f2937;
            color: #e5e7eb;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease-out;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .alert.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .alert.hide {
            opacity: 0;
            transform: translateX(100%);
        }
        
        .alert-error {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #1f2937 0%, #2d1f1f 100%);
        }
        
        .alert-warning {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #1f2937 0%, #2d291f 100%);
        }
        
        .alert-info {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #1f2937 0%, #1f2d3b 100%);
        }
        
        .alert-success {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #1f2937 0%, #1f2d28 100%);
        }
        
        .alert-icon {
            font-size: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            margin: 0 0 6px 0;
            font-size: 16px;
        }
        
        .alert-message {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
            color: #d1d5db;
        }
        
        .alert-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .alert-action-btn {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #e5e7eb;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .alert-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .alert-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            flex-shrink: 0;
        }
        
        .alert-close:hover {
            color: #e5e7eb;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .alert-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }
            
            .alert {
                padding: 14px 16px;
            }
        }
        
        #message { margin-top: 18px; font-weight: 600; color: #e5e7eb; text-align: left; }
        .printer-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:18px; margin-top:16px; padding: 8px; background: #ffffff; border-radius: 12px; border:1px solid #e5e7eb; }
        .printer-card { background: #ffffff; border:1px solid #e0e0e0; border-radius: 12px; padding: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.08); text-align:left; transition: transform .2s ease, box-shadow .2s ease; }
        .printer-card:hover { transform: translateY(-3px); }
        .printer-card h4 { color: #34495e; margin:0 0 10px 0; font-size:0.95em; border-bottom: 1px dashed rgba(0,0,0,0.08); padding-bottom:6px; }
        .printer-card p { margin: 6px 0; color: #555; font-size: 0.9em; }
        .service-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; margin-top:14px; padding: 8px; background: #111827; border-radius: 12px; border:1px solid rgba(255,255,255,0.06); }
        .service-grid.vertical { grid-template-columns: 1fr; }
        .status-layout { display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start; }
        .printer-summary { background:#111827; border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:12px; }
        .printer-summary h3 { margin:0 0 8px 0; color:#e5e7eb; font-size:1em; }
        .printer-summary-list { display:grid; grid-template-columns: 1fr; gap:12px; }
        .printer-summary-card { background:#1f2937; border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:10px; }
        .printer-summary-card h4 { margin:0 0 6px 0; color:#e5e7eb; font-size:0.95em; }
        .printer-summary-card .jobs { color:#9ca3af; font-weight:600; }
        .service-card { background: #1f2937; border:1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); text-align:left; transition: transform .2s ease, box-shadow .2s ease; }
        .service-card:hover { transform: translateY(-2px); }
        .service-card h4 { color: #e5e7eb; margin:0 0 8px 0; font-size:1em; border-bottom: 1px dashed rgba(255,255,255,0.08); padding-bottom:4px; }
        .service-card p { margin: 4px 0; color: #9ca3af; font-size: 0.85em; }
        .status-running { color: #00FF00; font-weight: 700; }
        .status-restarting, .status-pending, .status-start_pending, .status-stop_pending { color: #FFFF00; font-weight: 700; }
        .status-stopped { color: #FF0000; font-weight: 700; }
        .status-paused { color: #FFFF00; font-weight: 700; }
        .status-not_found, .status-error { color: #9ca3af; font-weight: 700; }
        #toastOverlay { background: rgba(0, 0, 0, 0.45); }
        .overlay-visible { display:flex; }
        .btn-danger { background:#e74c3c; }
        .service-progress { background:#eee; height:6px; border-radius:3px; }
        .service-progress-bar { height:6px; border-radius:3px; transition: background-color .25s ease, width .25s ease; }
        .bar-running { width:100%; background:#00FF00; }
        .bar-restarting, .bar-start_pending { width:75%; background:#FFFF00; }
        .bar-stopped { width:50%; background:#FF0000; }
        .bar-stop_pending { width:25%; background:#FFFF00; }
        .bar-error { width:0%; background:#FF0000; }
        .toast-icon-success { background:#22c55e; }
        .toast-icon-error { background:#ef4444; }
        .hidden { display:none; }
        #toast { background: #1f2937; border:1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 18px 22px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); max-width: 520px; }
        .toast-success { border-left: 6px solid #22c55e; }
        .toast-error { border-left: 6px solid #ef4444; }
        .toast-icon { background: #22c55e; }
        #toastClose { color: #9ca3af; }
        @media (max-width: 640px) {
            .container { margin: 20px auto; padding: 20px; }
            .connection-config { grid-template-columns: 1fr; gap: 12px; padding: 16px; }
            .tab-button { padding: 8px 10px; }
            .tabs-header { flex-wrap: wrap; }
            button { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="toastOverlay">
            <div id="toast" class="toast-success">
                <div class="toast-header">
                    <span id="toastIcon" class="toast-icon">‚úì</span>
                    <button id="toastClose">√ó</button>
                </div>
                <div class="toast-title" id="toastTitle"></div>
                <div class="toast-info" id="toastInfo"></div>
            </div>
        </div>
        <div class="connection-config">
            <h2>Configura√ß√µes de Conex√£o</h2>
            <div class="input-group">
                <label for="remoteHost">IP/M√°quina:</label>
                <input type="text" id="remoteHost" placeholder="Nome do Host ou IP Remoto">
            </div>
            <div class="input-group">
                <label for="username">Usu√°rio:</label>
                <input type="text" id="username" placeholder="Usu√°rio (para acesso remoto)">
            </div>
            <div class="input-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" placeholder="Senha (para acesso remoto)" autocomplete="current-password" autocapitalize="off" spellcheck="false">
            </div>
            <div class="input-group">
                <label for="domain">Dom√≠nio:</label>
                <input type="text" id="domain" placeholder="Dom√≠nio (opcional)" title="Ex.: VILLEFORT. Se usar &quot;DOM√çNIO\\usu√°rio&quot;, o dom√≠nio √© preenchido automaticamente.">
            </div>
            
            <button id="connectButton" class="button-indent">Conectar</button>
        </div>

        <p id="message"></p>

        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="services">Servi√ßos</button>
                <button class="tab-button" data-tab="printers">Impressoras</button>
            </div>
            <div class="tabs-content">
                <div id="services" class="tab-pane active">
                    <div class="filter-group">
                        <label for="serviceFilter">Filtro de Servi√ßos:</label>
                        <input type="text" id="serviceFilter" placeholder="Filtrar servi√ßos...">
                    </div>
                    <div class="btn-row">
                        <button id="robustClearButtonServices" class="btn-danger">üßπ Limpar Fila (Robusto)</button>
                        <button id="restartButton" class="button-indent">Reiniciar Servi√ßos</button>
                    </div>
                    <div class="status-layout">
                        <div id="servicesOutput" class="service-grid vertical hidden"></div>
                        <aside class="printer-summary">
                            <h3>Impressoras (Resumo)</h3>
                            <div id="printersSummary" class="printer-summary-list"></div>
                        </aside>
                        <aside class="printer-summary">
                            <h3>Hist√≥rico de Status</h3>
                            <div id="statusHistory" class="printer-summary-list"></div>
                        </aside>
                    </div>
                </div>
                <div id="printers" class="tab-pane">
                    <div class="btn-row">
                        <button id="listPrintersButton">Listar Impressoras</button>
                        <button id="robustClearButton" class="btn-danger">üßπ Limpar Fila (Robusto)</button>
                    </div>
                    <div id="printersOutput" class="printer-grid"></div>
                </div>
                
            </div>
        </div>


    </div>

    <script nonce="{{ csp_nonce }}">
        function normalizeDomain(d) { return (d || '').trim().toUpperCase(); }
        function extractDomainFromUsername(u) {
            const s = String(u || '');
            if (s.includes('\\')) {
                const parts = s.split('\\');
                if (parts[0] && parts[1]) return { domain: parts[0].toUpperCase(), user: parts[1] };
            }
            return { domain: '', user: s };
        }
        function composeCredentials(usernameInput, domainInput) {
            const extracted = extractDomainFromUsername(usernameInput);
            const domainNorm = normalizeDomain(domainInput || extracted.domain);
            const userNoDomain = extracted.user;
            const userWithDomain = domainNorm ? `${domainNorm}\\${userNoDomain}` : userNoDomain;
            return { domain: domainNorm, userNoDomain, userWithDomain };
        }
        function isValidHost(h) {
            const s = String(h || '').trim();
            const ip = /^(\d{1,3}\.){3}\d{1,3}$/;
            const host = /^[a-zA-Z0-9._-]{3,}$/;
            return ip.test(s) || host.test(s);
        }
        function validateConnectionInputs(remoteHost, usernameInput, password, domainInput) {
            const res = { ok: true, message: '' };
            const remoteEl = document.getElementById('remoteHost');
            const userEl = document.getElementById('username');
            const passEl = document.getElementById('password');
            const domainEl = document.getElementById('domain');
            
            // Limpar erros anteriores
            [remoteEl, userEl, passEl, domainEl].forEach(el => {
                el.classList.remove('field-error');
                el.classList.remove('field-success');
            });
            
            // Valida√ß√£o do host
            if (!remoteHost || !remoteHost.trim()) {
                res.ok = false; res.message = 'Informe o IP ou nome da m√°quina.';
                remoteEl.classList.add('field-error'); return res;
            }
            if (!isValidHost(remoteHost)) { 
                res.ok = false; res.message = 'IP/M√°quina inv√°lido. Use formato IPv4 (192.168.1.1) ou nome de host.'; 
                remoteEl.classList.add('field-error'); return res; 
            }
            
            // Valida√ß√£o do usu√°rio
            if (!usernameInput || !usernameInput.trim()) { 
                res.ok = false; res.message = 'Informe o usu√°rio para autentica√ß√£o.'; 
                userEl.classList.add('field-error'); return res; 
            }
            if (usernameInput.length > 100) {
                res.ok = false; res.message = 'Usu√°rio muito longo (m√°x. 100 caracteres).';
                userEl.classList.add('field-error'); return res;
            }
            
            // Valida√ß√£o da senha
            if (!password) { 
                res.ok = false; res.message = 'Informe a senha para autentica√ß√£o.'; 
                passEl.classList.add('field-error'); return res; 
            }
            if (password.length > 128) {
                res.ok = false; res.message = 'Senha muito longa (m√°x. 128 caracteres).';
                passEl.classList.add('field-error'); return res;
            }
            
            // Valida√ß√£o opcional do dom√≠nio
            if (domainInput && domainInput.trim() && domainInput.length > 50) {
                res.ok = false; res.message = 'Dom√≠nio muito longo (m√°x. 50 caracteres).';
                domainEl.classList.add('field-error'); return res;
            }
            
            // Campos v√°lidos - adicionar indicador visual
            remoteEl.classList.add('field-success');
            userEl.classList.add('field-success');
            passEl.classList.add('field-success');
            if (domainInput && domainInput.trim()) domainEl.classList.add('field-success');
            
            return res;
        }
        let printerUpdateInterval = null;
        let serviceStatusInterval = null;
        let statusEventSource = null;
        let sseReconnectTimer = null;
        let monitorStatusInterval = null;
        let serviceMonitorToken = null;
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? match[2] : null;
        }
        function csrfHeaders() {
            const token = getCookie('XSRF-TOKEN');
            return token ? { 'X-CSRF-Token': token } : {};
        }
        document.getElementById('restartButton').addEventListener('click', async () => {
            const button = document.getElementById('restartButton');
            const message = document.getElementById('message');

            const servicesOutput = document.getElementById('servicesOutput');
            const remoteHost = document.getElementById('remoteHost').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!remoteHost) {
                servicesOutput.innerHTML = '<p>Por favor, insira o IP/M√°quina para listar os servi√ßos.</p>';
                return;
            }

            button.disabled = true;
            message.textContent = 'Reiniciando servi√ßos sequencialmente...';
            message.className = '';

            try {
                const restartServicesResponse = await fetch('/restart_multiple_services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...csrfHeaders()
                    },
                    body: JSON.stringify({ remote_host: remoteHost, username: username, password: password })
                });

                const restartServicesData = await restartServicesResponse.json();

                if (restartServicesResponse.ok) {
                    message.textContent = restartServicesData.message;
                    message.className = 'success';
                    fetchAndRenderServiceStatus();
                } else {
                    message.textContent = restartServicesData.message || 'Erro desconhecido ao iniciar o rein√≠cio sequencial.';
                    message.className = 'error';
                    if (restartServicesData.results) {
                        const errorDetails = restartServicesData.results.filter(res => res.status === 'error').map(res => `${res.service}: ${res.message}`).join('\n');
                        if (errorDetails) {
                            message.textContent += `\nDetalhes dos erros:\n${errorDetails}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                message.textContent = 'N√£o foi poss√≠vel conectar ao servidor. Certifique-se de que o aplicativo est√° rodando.';
                message.className = 'error';
            } finally {
                button.disabled = false;
            }
        });

        async function fetchAndRenderPrinters() {
            const button = document.getElementById('listPrintersButton');
            const message = document.getElementById('message');
            const printersOutput = document.getElementById('printersOutput');

            const remoteHost = document.getElementById('remoteHost').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            button.disabled = true;
            
            message.textContent = 'Listando impressoras...';
            message.className = '';
            // N√£o limpa o output para permitir atualiza√ß√£o in-place

            try {
                const response = await fetch('/list_printers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...csrfHeaders()
                    },
                    body: JSON.stringify({ remote_host: remoteHost, username: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    message.textContent = data.message;
                    message.className = 'success';
                    printersOutput.innerHTML = ''; // Limpa antes de renderizar para atualiza√ß√£o
                    if (data.printers && data.printers.length > 0) {
                        const escapeHtml = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
                        data.printers.forEach(printer => {
                            const printerCard = document.createElement('div');
                            printerCard.className = 'printer-card';
                            const nameEl = document.createElement('h4');
                            nameEl.textContent = printer.Name;
                            printerCard.appendChild(nameEl);
                            const makeP = (label, val) => {
                                const p = document.createElement('p');
                                const strong = document.createElement('strong');
                                strong.textContent = label;
                                p.appendChild(strong);
                                p.appendChild(document.createTextNode(' ' + (val == null ? 'N/A' : String(val))));
                                return p;
                            };
                            printerCard.appendChild(makeP('Localiza√ß√£o:', printer.Location));
                            printerCard.appendChild(makeP('Driver:', printer.DriverName));
                            printerCard.appendChild(makeP('Porta:', printer.PortName));
                            printerCard.appendChild(makeP('Compartilhada:', printer.ShareName || 'N√£o'));
                            printerCard.appendChild(makeP('Status:', printer.Status || 'Desconhecido'));
                            printerCard.appendChild(makeP('Padr√£o:', printer.Default ? 'Sim' : 'N√£o'));
                            printerCard.appendChild(makeP('Local:', printer.Local ? 'Sim' : 'N√£o'));
                            printerCard.appendChild(makeP('Rede:', printer.Network ? 'Sim' : 'N√£o'));
                            printerCard.appendChild(makeP('Trabalhos Pendentes:', printer.JobCount));
                            printersOutput.appendChild(printerCard);
                        });
                    } else {
                        printersOutput.innerHTML = '<p>Nenhuma impressora encontrada.</p>';
                    }
                } else {
                    message.textContent = data.message || 'Erro desconhecido ao listar impressoras.';
                    message.className = 'error';

                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                message.textContent = 'N√£o foi poss√≠vel conectar ao servidor para listar impressoras. Certifique-se de que o aplicativo est√° rodando.';
                message.className = 'error';

            } finally {
                button.disabled = false;
            }
        }

        document.getElementById('robustClearButton').addEventListener('click', async () => {
            const message = document.getElementById('message');
            const remoteHost = document.getElementById('remoteHost').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const domain = document.getElementById('domain').value.trim();
            if (!remoteHost || !username || !password) {
                showToast('error', 'Dados incompletos', 'Informe IP, usu√°rio e senha.');
                return;
            }
            try {
                message.textContent = 'Executando limpeza robusta da fila...';
                message.className = '';
                const resp = await fetch('/clear_print_jobs_robust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username, password, domain })
                });
                const data = await resp.json();
                if (resp.ok) {
                    const before = data.before_count ?? 0;
                    const after = data.after_count ?? 0;
                    showToast('success', 'Fila limpa (robusto)', `Antes: ${before} | Depois: ${after}`);
                    await new Promise(r => setTimeout(r, 1500));
                    await fetchAndRenderPrinters();
                } else {
                    showToast('error', 'Erro ao limpar fila', data.message || 'Erro desconhecido');
                }
            } catch (e) {
                showToast('error', 'Falha de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
            }
        });

        document.getElementById('robustClearButtonServices').addEventListener('click', async () => {
            const message = document.getElementById('message');
            const remoteHost = document.getElementById('remoteHost').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const domain = document.getElementById('domain').value.trim();
            if (!remoteHost || !username || !password) {
                showToast('error', 'Dados incompletos', 'Informe IP, usu√°rio e senha.');
                return;
            }
            try {
                message.textContent = 'Executando limpeza robusta da fila...';
                message.className = '';
                const resp = await fetch('/clear_print_jobs_robust', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username, password, domain })
                });
                const data = await resp.json();
                if (resp.ok) {
                    const before = data.before_count ?? 0;
                    const after = data.after_count ?? 0;
                    showToast('success', 'Fila limpa (robusto)', `Antes: ${before} | Depois: ${after}`);
                    await new Promise(r => setTimeout(r, 1500));
                    await fetchAndRenderPrintersSummary();
                } else {
                    showToast('error', 'Erro ao limpar fila', data.message || 'Erro desconhecido');
                }
            } catch (e) {
                showToast('error', 'Falha de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
            }
        });

        // Fallback: se o bot√£o n√£o estiver presente por cache de template, cria dinamicamente
        document.addEventListener('DOMContentLoaded', () => {
            let btn = document.getElementById('robustClearButtonServices');
            if (!btn) {
                const restartBtn = document.getElementById('restartButton');
                if (restartBtn && restartBtn.parentElement) {
                    btn = document.createElement('button');
                    btn.id = 'robustClearButtonServices';
                    btn.className = 'btn-danger';
                    btn.textContent = 'üßπ Limpar Fila (Robusto)';
                    restartBtn.parentElement.appendChild(btn);
                    btn.addEventListener('click', async () => {
                        const message = document.getElementById('message');
                        const remoteHost = document.getElementById('remoteHost').value.trim();
                        const username = document.getElementById('username').value.trim();
                        const password = document.getElementById('password').value;
                        const domain = document.getElementById('domain').value.trim();
                        if (!remoteHost || !username || !password) {
                            showToast('error', 'Dados incompletos', 'Informe IP, usu√°rio e senha.');
                            return;
                        }
                        try {
                            message.textContent = 'Executando limpeza robusta da fila...';
                            message.className = '';
                            const resp = await fetch('/clear_print_jobs_robust', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                                body: JSON.stringify({ remote_host: remoteHost, username, password, domain })
                            });
                            const data = await resp.json();
                            if (resp.ok) {
                                const before = data.before_count ?? 0;
                                const after = data.after_count ?? 0;
                                showToast('success', 'Fila limpa (robusto)', `Antes: ${before} | Depois: ${after}`);
                                await new Promise(r => setTimeout(r, 1500));
                                await fetchAndRenderPrintersSummary();
                            } else {
                                showToast('error', 'Erro ao limpar fila', data.message || 'Erro desconhecido');
                            }
                        } catch (e) {
                            showToast('error', 'Falha de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
                        }
                    });
                }
            }
        });

        document.getElementById('listPrintersButton').addEventListener('click', () => {
            // Limpa qualquer intervalo existente antes de iniciar um novo
            if (printerUpdateInterval) {
                clearInterval(printerUpdateInterval);
            }
            fetchAndRenderPrinters(); // Chama imediatamente
        });

        

        // Fun√ß√£o para buscar e renderizar o status dos servi√ßos
        function normalizeStatus(status) {
            const s = String(status || '').toLowerCase();
            if (s.includes('running')) return { text: 'Rodando', cls: 'status-running', bar: 'bar-running' };
            if (s.includes('start') && s.includes('pending')) return { text: 'Reiniciando', cls: 'status-restarting', bar: 'bar-restarting' };
            if (s.includes('stop') && s.includes('pending')) return { text: 'Reiniciando', cls: 'status-restarting', bar: 'bar-stop_pending' };
            if (s.includes('stopped')) return { text: 'Parado', cls: 'status-stopped', bar: 'bar-stopped' };
            if (s.includes('paused')) return { text: 'Reiniciando', cls: 'status-paused', bar: 'bar-restarting' };
            return { text: status || 'Desconhecido', cls: 'status-error', bar: 'bar-error' };
        }

        async function fetchAndRenderServiceStatus() {
            const servicesOutput = document.getElementById('servicesOutput');
            const remoteHost = document.getElementById('remoteHost').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/get_services_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...csrfHeaders()
                    },
                    body: JSON.stringify({ remote_host: remoteHost, username: username, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    servicesOutput.innerHTML = ''; // Limpa antes de renderizar
                    if (data.services && data.services.length > 0) {
                        data.services.forEach(service => {
                            const serviceCard = document.createElement('div');
                            serviceCard.className = 'service-card';
                            const norm = normalizeStatus(service.status);
                            serviceCard.innerHTML = `
                                <h4>${service.name}</h4>
                                <p>Status: <span class="${norm.cls}">${norm.text}</span></p>
                                <div class="service-progress">
                                    <div class="service-progress-bar ${norm.bar}"></div>
                                </div>
                            `;
                            servicesOutput.appendChild(serviceCard);
                        });
                    } else {
                        servicesOutput.innerHTML = '<p>Nenhum servi√ßo encontrado ou monitorado.</p>';
                    }
                } else {
                    console.error('Erro ao buscar status dos servi√ßos:', data.message);
                    servicesOutput.innerHTML = `<p class="error">Erro ao carregar status dos servi√ßos: ${data.message || 'Erro desconhecido'}</p>`;
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o de status dos servi√ßos:', error);
                servicesOutput.innerHTML = '<p class="error">N√£o foi poss√≠vel conectar ao servidor para obter o status dos servi√ßos.</p>';
            }
        }

        function renderServiceList(services) {
            const servicesOutput = document.getElementById('servicesOutput');
            servicesOutput.innerHTML = '';
            if (services && services.length > 0) {
                services.forEach(service => {
                    const serviceCard = document.createElement('div');
                    serviceCard.className = 'service-card';
                    const norm = normalizeStatus(service.status);
                    const statusClass = norm.cls;
                    const barClass = norm.bar;
                    serviceCard.innerHTML = `
                                <h4>${service.name}</h4>
                                <p>Status: <span class="${statusClass}">${normalizeStatus(service.status).text}</span></p>
                                <div class="service-progress">
                                    <div class="service-progress-bar ${barClass}"></div>
                                </div>
                            `;
                    servicesOutput.appendChild(serviceCard);
                });
            } else {
                servicesOutput.innerHTML = '<p>Nenhum servi√ßo encontrado ou monitorado.</p>';
            }
        }
        

        async function startServiceMonitorIfNeeded() {
            const remoteHost = document.getElementById('remoteHost').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!remoteHost) {
                return null;
            }
            try {
                const resp = await fetch('/start_service_monitor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username, password })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    serviceMonitorToken = data.token;
                    return serviceMonitorToken;
                }
            } catch (e) {}
            return null;
        }

        async function connectServiceStatusEvents() {
            if (statusEventSource) return;
            if (!serviceMonitorToken) {
                const tok = await startServiceMonitorIfNeeded();
                if (!tok) return;
            }
            const url = `/events/services_status_by_token?token=${serviceMonitorToken}`;
            statusEventSource = new EventSource(url);
            statusEventSource.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    if (data && data.type === 'error') {
                        showToast('error', 'Monitoramento', 'Falha na comunica√ß√£o do monitor. Iniciando fallback.');
                        if (!serviceStatusInterval) {
                            serviceStatusInterval = setInterval(fetchAndRenderServiceStatus, 5000);
                        }
                        return;
                    }
                    if (serviceStatusInterval) { clearInterval(serviceStatusInterval); serviceStatusInterval = null; }
                    if (data && data.all && data.all.length) {
                        renderServiceList(data.all);
                    }
                    if (data && data.changed && data.changed.length > 0) {
                        const now = new Date();
                        const info = data.changed.map(c => `${c.service}: ${c.status} (${now.toLocaleString()})`).join('<br>');
                        const hist = document.getElementById('statusHistory');
                        const entry = document.createElement('div');
                        entry.className = 'printer-summary-card';
                        entry.innerHTML = info;
                        hist.prepend(entry);
                        data.changed.forEach(c => {
                            const cards = document.querySelectorAll('#servicesOutput .service-card');
                            cards.forEach(card => {
                                const name = card.querySelector('h4').textContent;
                                if (name === c.service) {
                                const span = card.querySelector('span');
                                const norm = normalizeStatus(c.status);
                                span.textContent = norm.text;
                                span.className = norm.cls;
                                const bar = card.querySelector('.service-progress-bar');
                                if (bar) {
                                    bar.className = `service-progress-bar ${norm.bar}`;
                                }
                                }
                            });
                        });
                        const serverTs = data.ts ? new Date(data.ts).getTime() : Date.now();
                        const latencyMs = Date.now() - serverTs;
                        if (latencyMs > 2000) {
                            showToast('error', 'Lat√™ncia Alta', `Atraso de ~${Math.round(latencyMs)}ms na atualiza√ß√£o.`);
                        }
                    }
                } catch (_) {}
            };
            statusEventSource.onerror = () => {
                if (statusEventSource) {
                    statusEventSource.close();
                    statusEventSource = null;
                }
                if (!sseReconnectTimer) {
                    sseReconnectTimer = setTimeout(() => {
                        sseReconnectTimer = null;
                        connectServiceStatusEvents();
                    }, 2000);
                }
                if (!serviceStatusInterval) {
                    serviceStatusInterval = setInterval(fetchAndRenderServiceStatus, 5000);
                }
            };
        }

        function disconnectServiceStatusEvents() {
            if (statusEventSource) {
                statusEventSource.close();
                statusEventSource = null;
            }
            if (sseReconnectTimer) {
                clearTimeout(sseReconnectTimer);
                sseReconnectTimer = null;
            }
            if (monitorStatusInterval) {
                clearInterval(monitorStatusInterval);
                monitorStatusInterval = null;
            }
        }

        // Chama a fun√ß√£o de status dos servi√ßos ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // N√£o conectar SSE automaticamente; somente ap√≥s conex√£o
        });

        // Adiciona event listeners para os bot√µes das abas
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                showTab(tabId);
            });
        });

        function showTab(tabId) {
            // Remove a classe 'active' de todos os bot√µes e pain√©is
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));

            // Adiciona a classe 'active' ao bot√£o e painel da aba selecionada
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // L√≥gica espec√≠fica para cada aba ao ser ativada
            if (tabId === 'services') {
                connectServiceStatusEvents();
                if (!serviceStatusInterval) {
                    serviceStatusInterval = setInterval(fetchAndRenderServiceStatus, 5000);
                }
                if (!monitorStatusInterval) {
                    monitorStatusInterval = setInterval(updateMonitorStatus, 5000);
                }
                fetchAndRenderStatusHistory();
            } else {
                disconnectServiceStatusEvents();
            }

            if (tabId === 'printers') {
                // N√£o inicia o intervalo automaticamente, apenas quando o bot√£o √© clicado
                // fetchAndRenderPrinters(); 
            } else {
                clearInterval(printerUpdateInterval);
                printerUpdateInterval = null;
            }
        }

        const toastOverlay = document.getElementById('toastOverlay');
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastInfo = document.getElementById('toastInfo');
        const toastIcon = document.getElementById('toastIcon');
        const toastClose = document.getElementById('toastClose');
        let toastTimer = null;

        function showToast(type, title, info, autoHideMs = 5000) {
            toast.className = type === 'success' ? 'toast-success' : 'toast-error';
            toastIcon.textContent = type === 'success' ? '‚úì' : '!';
            toastIcon.className = type === 'success' ? 'toast-icon toast-icon-success' : 'toast-icon toast-icon-error';
            toastTitle.textContent = title;
            toastInfo.innerHTML = info;
            toastOverlay.classList.add('overlay-visible');
            if (toastTimer) {
                clearTimeout(toastTimer);
            }
            if (autoHideMs && autoHideMs > 0) {
                toastTimer = setTimeout(() => hideToast(), autoHideMs);
            }
        }

        function hideToast() {
            toastOverlay.classList.remove('overlay-visible');
            if (toastTimer) {
                clearTimeout(toastTimer);
                toastTimer = null;
            }
        }

        // Fun√ß√£o para logging de tentativas de conex√£o
        function logConnectionAttempt(remoteHost, username, status, message, error = null) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                remoteHost,
                username: username ? username.substring(0, 3) + '***' : 'null', // Log seguro
                status,
                message: message.substring(0, 200), // Limitar tamanho
                error: error ? String(error).substring(0, 100) : null
            };
            
            // Armazenar no localStorage para an√°lise (m√°x. 50 entradas)
            try {
                const existingLogs = JSON.parse(localStorage.getItem('connectionLogs') || '[]');
                existingLogs.unshift(logEntry);
                if (existingLogs.length > 50) existingLogs.pop();
                localStorage.setItem('connectionLogs', JSON.stringify(existingLogs));
            } catch (e) {
                console.warn('Falha ao salvar log de conex√£o:', e);
            }
            
            console.log(`[CONNECTION] ${status}: ${message}`, logEntry);
        }

        toastClose.addEventListener('click', hideToast);

        // Sistema de Gerenciamento de Alertas
        const alertManager = {
            container: null,
            alertId: 0,
            
            init() {
                // Criar container de alertas se n√£o existir
                if (!document.getElementById('alert-container')) {
                    const container = document.createElement('div');
                    container.id = 'alert-container';
                    container.className = 'alert-container';
                    document.body.appendChild(container);
                    this.container = container;
                } else {
                    this.container = document.getElementById('alert-container');
                }
            },
            
            showAlert(type, title, message, actions = [], autoHide = true, duration = 5000) {
                this.init();
                const alertId = ++this.alertId;
                
                const alertEl = document.createElement('div');
                alertEl.className = `alert alert-${type}`;
                alertEl.id = `alert-${alertId}`;
                alertEl.setAttribute('role', 'alert');
                alertEl.setAttribute('aria-live', 'assertive');
                
                // √çcones por tipo
                const icons = {
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è',
                    success: '‚úÖ'
                };
                
                const actionsHtml = actions.length > 0 ? `
                    <div class="alert-actions">
                        ${actions.map(action => 
                            `<button class="alert-action-btn" onclick="${action.onclick}">${action.label}</button>`
                        ).join('')}
                    </div>
                ` : '';
                
                alertEl.innerHTML = `
                    <span class="alert-icon" aria-hidden="true">${icons[type] || 'üí°'}</span>
                    <div class="alert-content">
                        <h4 class="alert-title">${title}</h4>
                        <p class="alert-message">${message}</p>
                        ${actionsHtml}
                    </div>
                    <button class="alert-close" onclick="alertManager.hideAlert(${alertId})" aria-label="Fechar alerta">√ó</button>
                `;
                
                this.container.appendChild(alertEl);
                
                // Anima√ß√£o de entrada
                setTimeout(() => {
                    alertEl.classList.add('show');
                }, 10);
                
                // Auto-oculta√ß√£o
                if (autoHide) {
                    setTimeout(() => {
                        this.hideAlert(alertId);
                    }, duration);
                }
                
                return alertId;
            },
            
            hideAlert(alertId) {
                const alertEl = document.getElementById(`alert-${alertId}`);
                if (alertEl) {
                    alertEl.classList.remove('show');
                    alertEl.classList.add('hide');
                    
                    setTimeout(() => {
                        if (alertEl.parentNode) {
                            alertEl.parentNode.removeChild(alertEl);
                        }
                    }, 300);
                }
            },
            
            clearAll() {
                if (this.container) {
                    this.container.innerHTML = '';
                }
            }
        };
        
        // Inicializar gerenciador de alertas
        alertManager.init();
        
        // Fun√ß√µes de utilidade para mensagens de erro espec√≠ficas
        const errorMessages = {
            // Erros de autentica√ß√£o
            AUTHENTICATION: {
                INVALID_CREDENTIALS: {
                    title: 'Credenciais Inv√°lidas',
                    message: 'O usu√°rio ou senha informados est√£o incorretos. Verifique se:\\n\\n' +
                            '1. ‚úÖ O nome de usu√°rio est√° correto\\n' +
                            '2. ‚úÖ A senha foi digitada corretamente\\n' +
                            '3. ‚úÖ O dom√≠nio est√° correto (se aplic√°vel)',
                    type: 'error',
                    actions: [
                        {
                            label: 'Esqueci minha senha',
                            onclick: 'showPasswordRecovery()'
                        },
                        {
                            label: 'Tentar novamente',
                            onclick: 'focusUsernameField()'
                        }
                    ]
                },
                
                ACCOUNT_LOCKED: {
                    title: 'Conta Bloqueada',
                    message: 'Sua conta foi temporariamente bloqueada devido a m√∫ltiplas tentativas falhas.\\n\\n' +
                            'üîí Entre em contato com o administrador do sistema para desbloqueio.',
                    type: 'error',
                    actions: [
                        {
                            label: 'Contatar Administrador',
                            onclick: 'contactAdministrator()'
                        }
                    ]
                },
                
                ACCESS_DENIED: {
                    title: 'Acesso Negado',
                    message: 'Voc√™ n√£o possui permiss√£o para acessar este recurso.\\n\\n' +
                            'üìã Verifique se suas credenciais possuem os privil√©gios necess√°rios.',
                    type: 'error',
                    actions: [
                        {
                            label: 'Verificar Permiss√µes',
                            onclick: 'checkPermissions()'
                        }
                    ]
                }
            },
            
            // Erros de rede/conectividade
            NETWORK: {
                SERVER_UNREACHABLE: {
                    title: 'Servidor Indispon√≠vel',
                    message: 'N√£o foi poss√≠vel estabelecer conex√£o com o servidor remoto.\\n\\n' +
                            'üîç Verifique:\\n' +
                            '1. üåê A conex√£o de rede est√° est√°vel\\n' +
                            '2. üî• O firewall permite a conex√£o\\n' +
                            '3. üñ•Ô∏è O servidor est√° online e acess√≠vel',
                    type: 'warning',
                    actions: [
                        {
                            label: 'Testar Conex√£o',
                            onclick: 'testNetworkConnection()'
                        }
                    ]
                },
                
                RPC_UNAVAILABLE: {
                    title: 'Servi√ßo RPC Indispon√≠vel',
                    message: 'O servi√ßo de chamada de procedimento remoto (RPC) n√£o est√° respondendo.\\n\\n' +
                            'üõ†Ô∏è Isso pode indicar:\\n' +
                            '1. ‚ö†Ô∏è Servi√ßo RPC desativado no servidor\\n' +
                            '2. üõ°Ô∏è Bloqueio por firewall ou antiv√≠rus\\n' +
                            '3. üîå Problemas na configura√ß√£o de rede',
                    type: 'warning',
                    actions: [
                        {
                            label: 'Diagnosticar Rede',
                            onclick: 'runNetworkDiagnostics()'
                        }
                    ]
                }
            },
            
            // Erros de sistema
            SYSTEM: {
                WMI_ACCESS_DENIED: {
                    title: 'Acesso WMI Negado',
                    message: 'Falha na autentica√ß√£o com o Windows Management Instrumentation.\\n\\n' +
                            'üîê Poss√≠veis causas:\\n' +
                            '1. üë§ Credenciais sem privil√©gios administrativos\\n' +
                            '2. üìã Pol√≠ticas de seguran√ßa restritivas\\n' +
                            '3. üîß Configura√ß√£o incorreta de permiss√µes WMI',
                    type: 'error',
                    actions: [
                        {
                            label: 'Verificar Privil√©gios',
                            onclick: 'checkWMIPermissions()'
                        }
                    ]
                },
                
                SERVICE_UNAVAILABLE: {
                    title: 'Servi√ßo Indispon√≠vel',
                    message: 'O servi√ßo necess√°rio para esta opera√ß√£o n√£o est√° dispon√≠vel.\\n\\n' +
                            '‚öôÔ∏è Verifique se o servi√ßo est√° em execu√ß√£o no servidor remoto.',
                    type: 'warning',
                    actions: [
                        {
                            label: 'Verificar Servi√ßos',
                            onclick: 'checkRemoteServices()'
                        }
                    ]
                }
            }
        };
        
        // Fun√ß√£o para exibir erro baseado no tipo e c√≥digo
        function showErrorAlert(errorType, errorCode, technicalDetails = '') {
            const errorConfig = errorMessages[errorType]?.[errorCode];
            
            if (!errorConfig) {
                // Fallback para erro gen√©rico
                return alertManager.showAlert('error', 
                    'Erro Desconhecido', 
                    'Ocorreu um erro inesperado durante a opera√ß√£o.' +
                    (technicalDetails ? `\\n\\nDetalhes t√©cnicos: ${technicalDetails}` : '')
                );
            }
            
            let message = errorConfig.message;
            
            // Adicionar detalhes t√©cnicos em modo de desenvolvimento
            if (technicalDetails && console) {
                console.error(`[${errorType}:${errorCode}] ${technicalDetails}`);
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    message += `\\n\\nüîß Detalhes t√©cnicos (apenas desenvolvimento):\\n${technicalDetails}`;
                }
            }
            
            return alertManager.showAlert(
                errorConfig.type,
                errorConfig.title,
                message,
                errorConfig.actions,
                true,
                8000 // 8 segundos para erros
            );
        }
        
        // Fun√ß√µes de a√ß√£o para os bot√µes dos alertas
        function showPasswordRecovery() {
            alertManager.showAlert('info', 'Recupera√ß√£o de Senha', 
                'Entre em contato com o administrador do sistema para redefinir sua senha.\\n\\n' +
                'üìû Suporte: suporte@empresa.com\\n' +
                'üåê Portal: https://suporte.empresa.com');
        }
        
        function focusUsernameField() {
            document.getElementById('username')?.focus();
        }
        
        function contactAdministrator() {
            alertManager.showAlert('info', 'Contato do Administrador', 
                'Entre em contato com o administrador do sistema:\\n\\n' +
                'üë§ Nome: Administrador do Sistema\\n' +
                'üìß Email: admin@empresa.com\\n' +
                'üìû Telefone: (11) 99999-9999');
        }
        
        function testNetworkConnection() {
            alertManager.showAlert('info', 'Teste de Conex√£o', 
                'Iniciando diagn√≥stico de rede...\\n\\n' +
                'üì° Verificando conectividade com o servidor remoto.');
            // Implementar teste de conex√£o real aqui
        }
        
        // Fun√ß√µes de a√ß√£o para os bot√µes dos alertas
        function checkPermissions() {
            alertManager.showAlert('info', 'Verifica√ß√£o de Permiss√µes', 
                'Verificando privil√©gios de usu√°rio...\\n\\n' +
                'üîç Analisando permiss√µes necess√°rias para acesso WMI.\\n' +
                'üìã Requer privil√©gios administrativos no servidor remoto.');
            // Implementar verifica√ß√£o real de permiss√µes aqui
        }
        
        function runNetworkDiagnostics() {
            alertManager.showAlert('info', 'Diagn√≥stico de Rede', 
                'Executando diagn√≥stico completo de rede...\\n\\n' +
                'üåê Testando conectividade com o servidor\\n' +
                'üî• Verificando configura√ß√µes de firewall\\n' +
                'üõ°Ô∏è Analisando pol√≠ticas de seguran√ßa');
            // Implementar diagn√≥stico de rede real aqui
        }
        
        function checkWMIPermissions() {
            alertManager.showAlert('info', 'Permiss√µes WMI', 
                'Verificando configura√ß√µes do Windows Management Instrumentation...\\n\\n' +
                '‚öôÔ∏è Analisando permiss√µes WMI no servidor\\n' +
                'üîê Verificando pol√≠ticas de seguran√ßa DCOM\\n' +
                'üìä Validando configura√ß√µes de namespace WMI');
            // Implementar verifica√ß√£o real de permiss√µes WMI aqui
        }
        
        function checkRemoteServices() {
            alertManager.showAlert('info', 'Verifica√ß√£o de Servi√ßos', 
                'Verificando servi√ßos remotos necess√°rios...\\n\\n' +
                'üñ•Ô∏è Servi√ßo de Impress√£o (Spooler)\\n' +
                'üîó Servi√ßo RPC (Remote Procedure Call)\\n' +
                'üåê Servi√ßo WMI (Windows Management Instrumentation)');
            // Implementar verifica√ß√£o real de servi√ßos aqui
        }
        
        // Fun√ß√£o para mapear erros do backend para mensagens amig√°veis
        function mapBackendErrorToFriendlyMessage(backendError, technicalDetails = '') {
            const errorMap = {
                'Acesso negado': { type: 'AUTHENTICATION', code: 'INVALID_CREDENTIALS' },
                'access denied': { type: 'AUTHENTICATION', code: 'INVALID_CREDENTIALS' },
                'invalid credentials': { type: 'AUTHENTICATION', code: 'INVALID_CREDENTIALS' },
                'RPC': { type: 'NETWORK', code: 'RPC_UNAVAILABLE' },
                'n√£o foi poss√≠vel localizar': { type: 'NETWORK', code: 'SERVER_UNREACHABLE' },
                'n√£o h√° mais endpoints': { type: 'NETWORK', code: 'RPC_UNAVAILABLE' },
                'WMI': { type: 'SYSTEM', code: 'WMI_ACCESS_DENIED' },
                'service': { type: 'SYSTEM', code: 'SERVICE_UNAVAILABLE' }
            };
            
            // Encontrar a melhor correspond√™ncia
            let bestMatch = { type: 'SYSTEM', code: 'SERVICE_UNAVAILABLE' };
            
            for (const [keyword, mapping] of Object.entries(errorMap)) {
                if (backendError.toLowerCase().includes(keyword.toLowerCase())) {
                    bestMatch = mapping;
                    break;
                }
            }
            
            return showErrorAlert(bestMatch.type, bestMatch.code, technicalDetails);
        }

        document.getElementById('connectButton').addEventListener('click', async () => {
            const remoteHost = document.getElementById('remoteHost').value.trim();
            const usernameInput = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const domain = document.getElementById('domain').value.trim();
            const connectBtn = document.getElementById('connectButton');
            const messageElement = document.getElementById('message');
            
            // Bloquear m√∫ltiplas submiss√µes simult√¢neas
            if (connectBtn.getAttribute('data-submitting') === 'true') {
                return;
            }
            connectBtn.setAttribute('data-submitting', 'true');
            
            // Salvar dados atuais para persist√™ncia em caso de erro
            const currentFormData = {
                remoteHost,
                usernameInput,
                domain,
                password: password ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '' // N√£o armazenar senha real
            };
            sessionStorage.setItem('lastConnectionAttempt', JSON.stringify(currentFormData));
            
            const creds = composeCredentials(usernameInput, domain);
            if (creds.domain && !domain) {
                const domEl = document.getElementById('domain');
                domEl.value = creds.domain;
            }
            
            const v = validateConnectionInputs(remoteHost, creds.userNoDomain, password, creds.domain);
            if (!v.ok) { 
                // Usar sistema de alertas para erros de valida√ß√£o
                showErrorAlert('AUTHENTICATION', 'INVALID_CREDENTIALS', v.message);
                logConnectionAttempt(remoteHost, usernameInput, 'VALIDATION_ERROR', v.message);
                connectBtn.removeAttribute('data-submitting');
                return; 
            }
            
            const composedUser = creds.userWithDomain;

            connectBtn.disabled = true;
            messageElement.textContent = 'Conectando...';
            messageElement.className = '';
            
            // Log do in√≠cio da tentativa
            logConnectionAttempt(remoteHost, usernameInput, 'START', 'Iniciando tentativa de conex√£o WMI');

            try {
                const response = await fetch('/test_wmi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username: composedUser, password })
                });
                
                const data = await response.json();
                const now = new Date();
                
                if (response.ok && data.status === 'success') {
                    // Conex√£o bem-sucedida
                    messageElement.textContent = data.message;
                    messageElement.className = 'success';
                    logConnectionAttempt(remoteHost, usernameInput, 'SUCCESS', data.message);
                    
                    // Mostrar alerta de sucesso
                    alertManager.showAlert('success', 'Conex√£o Bem-sucedida', 
                        data.message + '\n\n‚úÖ Conex√£o estabelecida com sucesso.',
                        [], true, 3000);
                    
                    // Limpar dados de tentativa anterior
                    sessionStorage.removeItem('lastConnectionAttempt');
                    
                    fetchAndRenderServiceStatus();
                    fetchAndRenderPrintersSummary();
                    await startServiceMonitorIfNeeded();
                    connectServiceStatusEvents();
                    updateMonitorStatus();
                    
                } else {
                    // Erro na conex√£o - usar sistema de alertas
                    let errMsg = 'Falha na conex√£o.';
                    
                    if (data && data.message) {
                        errMsg = data.message;
                        // Usar o mapeador de erros para mensagens amig√°veis
                        mapBackendErrorToFriendlyMessage(errMsg, JSON.stringify(data));
                    } else {
                        // Fallback para erro gen√©rico
                        showErrorAlert('SYSTEM', 'SERVICE_UNAVAILABLE', 'Erro desconhecido na conex√£o');
                    }
                    
                    // Manter mensagem no elemento original tamb√©m (para compatibilidade)
                    messageElement.textContent = errMsg;
                    messageElement.className = 'error';
                    logConnectionAttempt(remoteHost, usernameInput, 'ERROR', errMsg, data);
                    
                    // Manter os dados do formul√°rio para corre√ß√£o
                    restoreFormData(remoteHost, usernameInput, domain);
                }
                
            } catch (e) {
                // Erro de rede ou servidor indispon√≠vel
                const errorMsg = 'N√£o foi poss√≠vel conectar ao servidor. Verifique:\\n1. Se o aplicativo est√° rodando\\n2. Sua conex√£o de rede\\n3. Firewall e permiss√µes';
                
                // Usar sistema de alertas para erros de rede
                showErrorAlert('NETWORK', 'SERVER_UNREACHABLE', e.message);
                
                messageElement.textContent = errorMsg;
                messageElement.className = 'error';
                logConnectionAttempt(remoteHost, usernameInput, 'NETWORK_ERROR', errorMsg, e);
                
                // Manter os dados do formul√°rio
                restoreFormData(remoteHost, usernameInput, domain);
                
            } finally {
                connectBtn.disabled = false;
                connectBtn.removeAttribute('data-submitting');
            }
        });
        
        // Fun√ß√£o para restaurar dados do formul√°rio ap√≥s erro
        function restoreFormData(remoteHost, username, domain) {
            try {
                if (remoteHost) document.getElementById('remoteHost').value = remoteHost;
                if (username) document.getElementById('username').value = username;
                if (domain) document.getElementById('domain').value = domain;
                // Senha n√£o √© restaurada por seguran√ßa
            } catch (e) {
                console.warn('Falha ao restaurar dados do formul√°rio:', e);
            }
        }

        // Event listener para o filtro de servi√ßos
        document.getElementById('serviceFilter').addEventListener('keyup', (event) => {
            const filterText = event.target.value.toLowerCase();
            const serviceCards = document.querySelectorAll('#servicesOutput .service-card');
            serviceCards.forEach(card => {
                const serviceName = card.querySelector('h4').textContent.toLowerCase();
                if (serviceName.includes(filterText)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        });

    </script>
    <script nonce="{{ csp_nonce }}">
        async function updateMonitorStatus() {
            const indicator = document.getElementById('monitorStatus');
            const token = (typeof serviceMonitorToken !== 'undefined') ? serviceMonitorToken : null;
            if (!indicator) return;
            if (!token) {
                indicator.innerHTML = '<div>Monitor: <span class="status-stopped">Inativo</span></div>';
                return;
            }
            try {
                const resp = await fetch(`/monitor_status?token=${token}`);
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    const running = !!data.running;
                    const alive = !!data.alive;
                    const runCls = running ? 'status-running' : 'status-stopped';
                    const aliveCls = alive ? 'status-running' : 'status-stopped';
                    indicator.innerHTML = `<div>Monitor: <span class="${runCls}">${running ? 'Ativo' : 'Inativo'}</span></div><div>Thread: <span class="${aliveCls}">${alive ? 'Viva' : 'Parada'}</span></div>`;
                } else {
                    indicator.innerHTML = '<div>Monitor: <span class="status-stopped">Erro</span></div>';
                }
            } catch (_) {
                indicator.innerHTML = '<div>Monitor: <span class="status-stopped">Falha</span></div>';
            }
        }
    </script>
    <script nonce="{{ csp_nonce }}">
        function diagnoseWmiMessage(msg) {
            const m = String(msg || '').toLowerCase();
            if (!m) return null;
            if (m.includes('acesso negado') || m.includes('access is denied') || m.includes('-2147024891')) {
                return 'Verifique: Dom√≠nio correto (ex.: VILLEFORT), Remote Enable em root\\cimv2, permiss√µes DCOM (Remote Access/Launch/Activation) e regra de firewall WMI-In. Para conta local admin, aplique LocalAccountTokenFilterPolicy=1.';
            }
            if (m.includes('rpc server is unavailable') || m.includes('-2147023174')) {
                return 'RPC indispon√≠vel: libere porta 135/TCP e regras relacionadas (DCOM/WMI), verifique conectividade e servi√ßo RPC no host.';
            }
            if (m.includes('par√¢metro inv√°lido') || m.includes('invalid parameter') || m.includes('-2147217400')) {
                return 'Par√¢metro inv√°lido: confirme formato de credenciais (DOM√çNIO\\usu√°rio) e que o campo Dom√≠nio est√° correto (ex.: VILLEFORT).';
            }
            return null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const msgEl = document.getElementById('message');
            const observer = new MutationObserver(() => {
                if (msgEl.classList.contains('error')) {
                    const hint = diagnoseWmiMessage(msgEl.textContent || '');
                    if (hint) {
                        showToast('error', 'Diagn√≥stico WMI', hint, 7000);
                    }
                }
            });
            observer.observe(msgEl, { characterData: false, childList: true, attributes: true, attributeFilter: ['class'] });
        });
    </script>
    <script nonce="{{ csp_nonce }}">
        async function fetchAndRenderPrintersSummary() {
            const messageEl = document.getElementById('message');
            const remoteHost = document.getElementById('remoteHost').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!messageEl.classList.contains('success')) return;
            if (!remoteHost || !username || !password) return;
            try {
                const resp = await fetch('/list_printers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
                    body: JSON.stringify({ remote_host: remoteHost, username, password })
                });
                const data = await resp.json();
                const container = document.getElementById('printersSummary');
                container.innerHTML = '';
                if (resp.ok && Array.isArray(data.printers)) {
                    data.printers.forEach(p => {
                        const card = document.createElement('div');
                        card.className = 'printer-summary-card';
                        const h4 = document.createElement('h4');
                        h4.textContent = p.Name || 'Impressora';
                        const jobs = document.createElement('div');
                        jobs.className = 'jobs';
                        jobs.textContent = `Trabalhos na fila: ${typeof p.JobCount === 'number' ? p.JobCount : (p.JobCount || 0)}`;
                        card.appendChild(h4);
                        card.appendChild(jobs);
                        container.appendChild(card);
                    });
                }
            } catch (_) {}
        }
        document.addEventListener('DOMContentLoaded', () => {
            const messageEl = document.getElementById('message');
            const servicesOutput = document.getElementById('servicesOutput');
            const observer = new MutationObserver(() => {
                if (messageEl.classList.contains('success')) {
                    servicesOutput.classList.remove('hidden');
                }
            });
            observer.observe(messageEl, { attributes: true, attributeFilter: ['class'] });
        });
    </script>
    <script nonce="{{ csp_nonce }}">
        async function fetchAndRenderStatusHistory() {
            const messageEl = document.getElementById('message');
            if (!messageEl.classList.contains('success')) return;
            const remoteHost = document.getElementById('remoteHost').value.trim();
            if (!remoteHost) return;
            try {
                const resp = await fetch(`/services_status_history?host=${encodeURIComponent(remoteHost)}&limit=100`);
                const data = await resp.json();
                const container = document.getElementById('statusHistory');
                container.innerHTML = '';
                if (resp.ok && Array.isArray(data.items)) {
                    data.items.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'printer-summary-card';
                        const norm = normalizeStatus(item.to);
                        card.innerHTML = `${item.service}: <span class="${norm.cls}">${norm.text}</span> (${new Date(item.ts).toLocaleString()})`;
                        container.prepend(card);
                    });
                }
            } catch (_) {}
        }
    </script>
</body>
</html>
